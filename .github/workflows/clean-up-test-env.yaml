name: Clean up test environment

# only trigger on pull request closed events
on:
  pull_request:
    types: [ closed ]

jobs:
  cleanup_test_env:
    name: Clean up test environment ${{ github.ref }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install CDK dependencies
        shell: bash
        working-directory: packages/otelbin-validation
        run: |
          npm ci

      - name: Get test environment name
        id: get_test_env_name
        shell: bash
        env:
          REF_NAME: ${{ github.head_ref || github.ref_name }}
        # When the trigger is a pull event, use the PR's branch name (`github.head_ref`), which
        # is available only for pull trigger. Otherwise, use the branch on which the commit was pushed.
        # (Ref names in pull requests are in the shape of `<pr_id>/merge` and those will break CDK.)
        run: |
          echo "test_env_name=$(./.github/workflows/scripts/test_env_name.sh)" >> $GITHUB_OUTPUT || exit 1

      - name: Select credentials
        id: select_credentials
        shell: bash
        env:
          TEST_ENVIRONMENT_NAME: ${{ steps.get_test_env_name.outputs.test_env_name }}
        run: |
          if [ "${TEST_ENVIRONMENT_NAME}" == 'main' ]; then
            echo 'aws_account=${{secrets.AWS_ACCOUNT_PROD}}' >> ${GITHUB_OUTPUT}
            echo 'aws_access_key=${{secrets.AWS_ACCESS_KEY_ID_PROD}}' >> ${GITHUB_OUTPUT}
            echo 'aws_secret_access_key=${{secrets.AWS_SECRET_ACCESS_KEY_PROD}}' >> ${GITHUB_OUTPUT}
          else
            echo 'aws_account=${{secrets.AWS_ACCOUNT_DEV}}' >> ${GITHUB_OUTPUT}
            echo 'aws_access_key=${{secrets.AWS_ACCESS_KEY_ID_DEV}}' >> ${GITHUB_OUTPUT}
            echo 'aws_secret_access_key=${{secrets.AWS_SECRET_ACCESS_KEY_DEV}}' >> ${GITHUB_OUTPUT}
          fi

      - name: Delete validation backend
        shell: bash
        working-directory: packages/otelbin-validation
        env:
          AWS_ACCESS_KEY_ID: ${{ steps.select_credentials.outputs.aws_access_key }}
          AWS_SECRET_ACCESS_KEY: ${{ steps.select_credentials.outputs.aws_secret_access_key }}
          AWS_DEFAULT_REGION: 'us-east-2' 
          CDK_DEPLOY_ACCOUNT: ${{ steps.select_credentials.outputs.aws_account }}
          CDK_DEPLOY_REGION: 'us-east-2'
          GH_TOKEN: ${{ github.token }}
          TEST_ENVIRONMENT_NAME: ${{ steps.get_test_env_name.outputs.test_env_name }}
        run: |
          npx projen destroy --force